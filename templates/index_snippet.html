{{define "index_snippet.html"}}
<section>
    <div class="summary-stats">
        <div class="stat-card">
            <div class="stat-number">{{.TotalRepos}}</div>
            <div class="stat-label">Repositories</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{.UniqueBadgeCount}}</div>
            <div class="stat-label">Unique Badges</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{.ReposWithBadges}}</div>
            <div class="stat-label">With Badges</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{.ReposNoBadges}}</div>
            <div class="stat-label">No Badges</div>
        </div>
    </div>
</section>

<section>
    <h1>Badges</h1>

    {{range .BadgesByCategory}}
    <div class="badge-category">
        <div class="badge-category-title">{{.Name}}</div>
        <div class="badge-filters">
            {{range .Badges}}
            <div class="badge-filter" data-badge-id="{{.ID}}" onclick="toggleBadgeFilter(this)">
                <a href="/badges/{{.ID}}.html" hx-get="/snippets/badges/{{.ID}}.html" hx-target="#content" hx-push-url="/badges/{{.ID}}.html" onclick="event.stopPropagation()">
                    <img src="{{.ImageURL}}" alt="{{.Name}}" loading="lazy">
                </a>
                <span class="badge-name">{{.Name}} ({{.Count}})</span>
                <button type="button" class="badge-filter-invert" onclick="toggleBadgeInvert(event, this)" title="Toggle invert filter (show repos without this badge)">
                    <span class="invert-icon">â‰ </span>
                </button>
            </div>
            {{end}}
        </div>
    </div>
    {{end}}
</section>

<section>
    <h1>Repositories</h1>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search repositories..." onkeyup="filterRepos()">
    </div>

    <div class="repo-table">
        <div class="repo-table-header">
            <div class="repo-name-header">Repository</div>
            <div class="repo-badges-header">Badges</div>
        </div>
        {{range .Repositories}}
        <div class="repo-row" data-badges="{{range .BadgeIDs}}{{.}} {{end}}" data-name="{{.Name}}">
            <div class="repo-name-cell">
                <a href="/repos/{{.Name | urlize}}.html" hx-get="/snippets/repos/{{.Name | urlize}}.html" hx-target="#content" hx-push-url="/repos/{{.Name | urlize}}.html">{{.Name}}</a>
            </div>
            <div class="repo-badges-cell">{{.BadgeCount}}</div>
        </div>
        {{end}}
    </div>
</section>

<script>
var selectedBadges = new Set();
var invertedBadges = new Set();

function toggleBadgeFilter(el) {
    var id = el.getAttribute('data-badge-id');
    if (selectedBadges.has(id)) {
        selectedBadges.delete(id);
        // When deselecting, also remove from inverted set
        invertedBadges.delete(id);
        el.classList.remove('inverted');
    } else {
        selectedBadges.add(id);
    }
    el.classList.toggle('selected');
    applyFilters();
}

function toggleBadgeInvert(event, el) {
    event.stopPropagation();
    var badgeFilter = el.closest('.badge-filter');
    var id = badgeFilter.getAttribute('data-badge-id');
    
    // Only allow inverting if badge is selected
    if (!selectedBadges.has(id)) {
        // Auto-select the badge if not already selected
        selectedBadges.add(id);
        badgeFilter.classList.add('selected');
    }
    
    if (invertedBadges.has(id)) {
        invertedBadges.delete(id);
        badgeFilter.classList.remove('inverted');
    } else {
        invertedBadges.add(id);
        badgeFilter.classList.add('inverted');
    }
    applyFilters();
}

function filterRepos() {
    applyFilters();
}

function applyFilters() {
    var searchTerm = document.getElementById('searchInput').value.toLowerCase();
    var rows = document.querySelectorAll('.repo-row');

    rows.forEach(function(row) {
        var name = row.getAttribute('data-name').toLowerCase();
        var badges = row.getAttribute('data-badges').split(' ').filter(Boolean);

        var matchesSearch = name.includes(searchTerm);
        var matchesBadges = true;

        if (selectedBadges.size > 0) {
            matchesBadges = Array.from(selectedBadges).every(function(bid) {
                var hasBadge = badges.includes(bid);
                var isInverted = invertedBadges.has(bid);
                // If inverted, we want repos that DON'T have the badge
                // If not inverted, we want repos that DO have the badge
                return isInverted ? !hasBadge : hasBadge;
            });
        }

        if (matchesSearch && matchesBadges) {
            row.classList.remove('hidden');
        } else {
            row.classList.add('hidden');
        }
    });
}
</script>
{{end}}
